def projectDir = "../KingsLeague"

pipeline {
    agent any
    stages {
        stage("Clone project") {
            steps {
                git branch: 'master', url: 'https://github.com/AhmedEnnaime/KingsLeague.git'
            }
        }

        stage("Build project without test") {
            steps {
                dir(projectDir) {
                    sh './gradlew build -x test'
                }
            }
        }
        
        stage("Testing") {
            steps {
                dir(projectDir) {
                    sh "./gradlew :team-service:test"
                }
            }
        }
        
        stage("Publish code coverage") {
            steps {
                dir("../KingsLeague/team-service") {
                    jacoco(
                        execPattern: '**/*.exec',
                        sourcePattern: 'src/main/kotlin/com/youcode/kingsleague/team_service/services',
                        exclusionPattern: 'src/test*'
                    )
                }
                
            }
        }

        stage("Deploy to DockerHub with Jib") {
            steps {
                dir(projectDir) {
                    withCredentials([string(credentialsId: 'DOCKER_PASSWORD', variable: 'DOCKER_PASSWORD'), string(credentialsId: 'DOCKER_USERNAME', variable: 'DOCKER_USERNAME')]) {
                        sh '''
                        echo "${DOCKER_PASSWORD}" | docker login -u "${DOCKER_USERNAME}" --password-stdin
                        ./gradlew :team-service:jib -Djib.to.auth.username="${DOCKER_USERNAME}" -Djib.to.auth.password="${DOCKER_PASSWORD}"
                        '''
                    }
                }
            }
        }
    }
}
